<!-- src/main/resources/templates/board.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Guestbook</title>

    <!-- Ïä§ÌÉÄÏùº -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">

    <!-- CSRF (JS fetchÏö©) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body class="container py-5" style="max-width:680px">
    <!-- ‚îÄ‚îÄ‚îÄ ÏÉÅÎã® Ïö∞Ï∏° Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº ‚îÄ‚îÄ‚îÄ -->
    <nav class="navbar navbar-light mb-4">
        <div class="container-fluid p-0">

            <!-- Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÏóêÍ≤åÎßå ÎÖ∏Ï∂ú -->
            <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()" class="ms-auto">
                <!-- th:action ÎçïÎ∂ÑÏóê _csrf hidden ÌïÑÎìúÍ∞Ä ÏûêÎèô ÏÇΩÏûÖ -->
                <button type="submit" class="btn btn-outline-secondary btn-sm">
                    Î°úÍ∑∏ÏïÑÏõÉ
                </button>
            </form>
        </div>
    </nav>
    <h1 class="mb-4">Guestbook</h1>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Í∏Ä ÏûëÏÑ± Ìèº ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <form th:action="@{/board}" method="post" class="input-group mb-4">
        <input type="text" name="content" class="form-control" placeholder="Î∞©Î™ÖÎ°ùÏóê ÎÇ®Í∏∏ Ìïú ÎßàÎîîÎ•º Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî" maxlength="200"
            required>
        <button class="btn btn-primary" type="submit">Îì±Î°ù</button>
    </form>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Í∏Ä Î™©Î°ù ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <ul class="list-group">
        <li th:each="post : ${posts}" th:id="'row-' + ${post.id}" class="list-group-item">

            <!-- Ìïú Ï§Ñ Î†àÏù¥ÏïÑÏõÉ -->
            <div class="d-flex justify-content-between align-items-start flex-wrap w-100">

                <!-- ÏûëÏÑ±Ïûê ¬∑ ÎÇ¥Ïö© -->
                <div class="me-2 flex-grow-1">

                    <!-- ÏûëÏÑ±Ïûê -->
                    <strong th:text="${post.author}">ÏûëÏÑ±Ïûê</strong>
                    <span class="text-muted">:</span>

                    <!-- ====== Î≥¥Í∏∞ Î™®Îìú ====== -->
                    <span th:id="'content-' + ${post.id}" th:text="${post.content}">ÎÇ¥Ïö©</span>

                    <!-- ====== Ìé∏Ïßë Î™®Îìú ====== -->
                    <textarea th:id="'editbox-' + ${post.id}" class="form-control d-none mt-2" rows="3" maxlength="200"
                        th:text="${post.content}"></textarea>
                </div>

                <!-- ÏûëÏÑ±‚ÄßÏàòÏ†ï ÏãúÍ∞Å & Î≤ÑÌäº Î¨∂Ïùå -->
                <div class="d-flex align-items-center gap-2">

                    <!-- ÏûëÏÑ±¬∑ÏàòÏ†ï ÏãúÍ∞Å -->
                    <small class="text-muted" th:text="${#temporals.format(post.createdAt,'yy-MM-dd HH:mm')}">
                        25-06-11 21:31
                    </small>

                    <!-- ‚úèÔ∏è ÏàòÏ†ï ÏïÑÏù¥ÏΩò Î≤ÑÌäº -->
                    <button th:id="'editBtn-' + ${post.id}" class="btn btn-outline-secondary btn-icon"
                        th:if="${#authorization.expression('hasRole(''ADMIN'')') or #authentication.name == post.author}"
                        th:onclick="|startEdit(${post.id})|" type="button">
                        <i class="bi bi-pencil-fill"></i> <!-- Bootstrap Icons -->
                    </button>

                    <!-- üíæ Ï†ÄÏû• / Ï∑®ÏÜå Î≤ÑÌäº (Ìé∏Ïßë Î™®ÎìúÏùº ÎïåÎßå) -->
                    <button th:id="'saveBtn-' + ${post.id}" class="btn btn-primary btn-icon d-none"
                        th:onclick="|saveEdit(${post.id})|" type="button">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button th:id="'cancelBtn-' + ${post.id}" class="btn btn-light btn-icon d-none"
                        th:onclick="|cancelEdit(${post.id})|" type="button">
                        <i class="bi bi-x-lg"></i>
                    </button>

                    <!-- üóëÔ∏è ÏÇ≠Ï†ú ÏïÑÏù¥ÏΩò Î≤ÑÌäº -->
                    <form
                        th:if="${#authorization.expression('hasRole(''ADMIN'')') or #authentication.name == post.author}"
                        th:action="@{/board/delete/{id}(id=${post.id})}" method="post" class="m-0">
                        <button class="btn btn-outline-danger btn-icon" onclick="return confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </li>
    </ul>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ïù∏ÎùºÏù∏ Ïä§ÌÅ¨Î¶ΩÌä∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        /* ‚ë† CSRF Ìó§Îçî¬∑ÌÜ†ÌÅ∞ */
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        /* === Î≥¥Í∏∞ ‚Üí Ìé∏Ïßë === */
        function startEdit(id) {
            document.getElementById('content-' + id).classList.add('d-none');
            document.getElementById('editbox-' + id).classList.remove('d-none');

            document.getElementById('editBtn-' + id).classList.add('d-none');
            document.getElementById('saveBtn-' + id).classList.remove('d-none');
            document.getElementById('cancelBtn-' + id).classList.remove('d-none');
        }

        /* === Ìé∏Ïßë Ï∑®ÏÜå === */
        function cancelEdit(id) {
            document.getElementById('content-' + id).classList.remove('d-none');
            document.getElementById('editbox-' + id).classList.add('d-none');

            document.getElementById('editBtn-' + id).classList.remove('d-none');
            document.getElementById('saveBtn-' + id).classList.add('d-none');
            document.getElementById('cancelBtn-' + id).classList.add('d-none');
        }

        /* === Ìé∏Ïßë ‚Üí ÏÑúÎ≤Ñ Ï†ÄÏû• === */
        function saveEdit(id) {
            const textarea = document.getElementById('editbox-' + id);

            /* ‚ë° Ìó§Îçî Í∞ùÏ≤¥Î•º Î®ºÏ†Ä ÎßåÎì§Í≥† ÎèôÏ†ÅÏúºÎ°ú ÌÇ§ Ï∂îÍ∞Ä */
            const hdrs = { 'Content-Type': 'application/json' };
            hdrs[csrfHeader] = csrfToken;

            fetch('/api/board/' + id, {
                method: 'PUT',
                headers: hdrs,
                body: JSON.stringify({ content: textarea.value })
            })
                .then(r => {
                    if (!r.ok) throw r.status;
                    return r.json();
                })
                .then(json => {
                    document.getElementById('content-' + id).textContent = json.content;
                    cancelEdit(id);         // UI ÏõêÎ≥µ
                })
                .catch(status => {
                    alert(status === 403 ? 'ÏàòÏ†ï Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.' : 'Ï†ÄÏû• Ïã§Ìå®');
                });
        }
        /*]]>*/
    </script>
    
    <style>
        /* ÏïÑÏù¥ÏΩòÎßå Îì§Ïñ¥Í∞ÄÎäî ÎØ∏Îãà Î≤ÑÌäº Í≥µÌÜµ */
        .btn-icon {
            padding: .25rem .4rem;
            /* btn-sm Î≥¥Îã§ ÏÇ¥Ïßù ÏûëÍ≤å */
            line-height: 1;
            /* ÏïÑÏù¥ÏΩò ÏÑ∏Î°ú Ï§ëÏïô */
            font-size: 1rem;
            /* ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ */
        }
    </style>
</body>

</html>